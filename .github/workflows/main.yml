name: Daily Market Briefing (Auto-Detect Model)

on:
  schedule:
    - cron: '0 22 * * 1-5' # í‰ì¼ ì•„ì¹¨ 7ì‹œ
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰

jobs:
  send-briefing:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Libraries
        # google-generativeai ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ìµœì‹ ìœ¼ë¡œ ì„¤ì¹˜
        run: pip install -U google-generativeai python-telegram-bot yfinance pytz

      - name: Run Bot Script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        shell: python
        run: |
          import os
          import asyncio
          import yfinance as yf
          import google.generativeai as genai
          from telegram import Bot
          from datetime import datetime
          import pytz

          # --- 1. í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ---
          GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY")
          TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")
          CHAT_ID = os.environ.get("CHAT_ID")

          if not GEMINI_API_KEY or not TELEGRAM_TOKEN:
              print("âŒ Error: API Key ëˆ„ë½")
              exit(1)

          genai.configure(api_key=GEMINI_API_KEY)

          # --- 2. ë°ì´í„° ìˆ˜ì§‘ (ì •ìƒ ì‘ë™ í™•ì¸ë¨) ---
          def get_market_data():
              tickers = {
                  "S&P 500": "^GSPC",
                  "NASDAQ": "^IXIC",
                  "VIX (ê³µí¬ì§€ìˆ˜)": "^VIX",
                  "10ë…„ë¬¼ êµ­ì±„ê¸ˆë¦¬": "^TNX",
                  "ê¸°ìˆ (Tech)": "XLK",
                  "ê¸ˆìœµ": "XLF",
                  "í—¬ìŠ¤ì¼€ì–´": "XLV",
                  "ë°˜ë„ì²´": "SOXX"
              }
              
              data_summary = []
              print("ğŸ“Š ì¦ì‹œ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...")
              
              for name, ticker in tickers.items():
                  try:
                      stock = yf.Ticker(ticker)
                      hist = stock.history(period="5d")
                      if len(hist) < 2: continue
                      
                      current = hist['Close'].iloc[-1]
                      prev = hist['Close'].iloc[-2]
                      change = ((current - prev) / prev) * 100
                      icon = "ğŸ”º" if change > 0 else "ğŸ”¹"
                      data_summary.append(f"- {name}: {current:,.2f} ({icon} {change:.2f}%)")
                  except:
                      pass # ì—ëŸ¬ ë¬´ì‹œí•˜ê³  ë‹¤ìŒ ê²ƒ ì§„í–‰
              return "\n".join(data_summary)

          # --- 3. ëª¨ë¸ ìë™ íƒìƒ‰ ë° ë¸Œë¦¬í•‘ ìƒì„± (í•µì‹¬ ìˆ˜ì •) ---
          def generate_briefing(market_data):
              kst = pytz.timezone('Asia/Seoul')
              today_str = datetime.now(kst).strftime("%Yë…„ %mì›” %dì¼")
              
              prompt = f"""
              [ë‚ ì§œ]: {today_str}
              [ì¦ì‹œ ë°ì´í„°]:
              {market_data}
              
              ìœ„ ë°ì´í„°ë¥¼ ë³´ê³  í…”ë ˆê·¸ë¨ìš© 'ëª¨ë‹ ë¸Œë¦¬í•‘'ì„ ì‘ì„±í•´.
              ì¡°ê±´:
              1. ì œëª©: 'ğŸ“… {today_str} ì‹œì¥ ìš”ì•½'
              2. ë‚´ìš©: S&P500/ë‚˜ìŠ¤ë‹¥ ë¶„ìœ„ê¸°, ì£¼ìš” ì„¹í„° íë¦„, VIX/ê¸ˆë¦¬ í•´ì„.
              3. ê²°ë¡ : íˆ¬ìì ì¡°ì–¸ 1ì¤„.
              4. ê¸¸ì´: 500ì ì´ë‚´, ì´ëª¨ì§€ ì‚¬ìš©.
              """

              print("ğŸ¤– ì‚¬ìš© ê°€ëŠ¥í•œ AI ëª¨ë¸ ê²€ìƒ‰ ì¤‘...")
              valid_model_name = None
              
              try:
                  # 1. ë‚´ API í‚¤ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ëª¨ë¸ ë¦¬ìŠ¤íŠ¸ë¥¼ ì‹¹ ë‹¤ ê¸ì–´ì˜µë‹ˆë‹¤.
                  for m in genai.list_models():
                      if 'generateContent' in m.supported_generation_methods:
                          print(f"  - ë°œê²¬ëœ ëª¨ë¸: {m.name}")
                          # ìš°ë¦¬ê°€ ì„ í˜¸í•˜ëŠ” ëª¨ë¸ì´ ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„  ì„ íƒ
                          if 'gemini-1.5-flash' in m.name:
                              valid_model_name = m.name
                              break
                          if 'gemini-pro' in m.name and valid_model_name is None:
                              valid_model_name = m.name
                  
                  # 2. ì„ í˜¸ ëª¨ë¸ì„ ëª» ì°¾ì•˜ìœ¼ë©´, ëª©ë¡ì˜ ë§¨ ì²« ë²ˆì§¸ ëª¨ë¸ì„ ì”ë‹ˆë‹¤.
                  if not valid_model_name:
                      # ë‹¤ì‹œ ê²€ìƒ‰í•´ì„œ ì•„ë¬´ê±°ë‚˜ í•˜ë‚˜ ì§‘ìŒ
                      for m in genai.list_models():
                          if 'generateContent' in m.supported_generation_methods:
                              valid_model_name = m.name
                              break
                  
                  if not valid_model_name:
                      return f"âŒ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ì´ ì—†ìŠµë‹ˆë‹¤. API ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.\n\n[ë°ì´í„°]\n{market_data}"

                  print(f"ğŸ¯ ìµœì¢… ì„ íƒëœ ëª¨ë¸: {valid_model_name}")
                  
                  # 3. ì„ íƒëœ ëª¨ë¸ë¡œ ìƒì„± ìš”ì²­
                  model = genai.GenerativeModel(valid_model_name)
                  response = model.generate_content(prompt)
                  return response.text

              except Exception as e:
                  print(f"âŒ AI ìƒì„± ì¤‘ ì˜¤ë¥˜: {e}")
                  return f"AI ë¶„ì„ ì‹¤íŒ¨ (ì˜¤ë¥˜: {e}).\n\n[ì›ë³¸ ë°ì´í„°]\n{market_data}"

          # --- 4. ì‹¤í–‰ ---
          async def main():
              raw_data = get_market_data()
              if not raw_data: raw_data = "ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨"
              
              briefing = generate_briefing(raw_data)
              
              bot = Bot(token=TELEGRAM_TOKEN)
              # ë§ˆí¬ë‹¤ìš´ ì—†ì´ ì•ˆì „í•˜ê²Œ í…ìŠ¤íŠ¸ë§Œ ë³´ëƒ„
              await bot.send_message(chat_id=CHAT_ID, text=briefing)
              print("âœ… ì „ì†¡ ì™„ë£Œ")

          if __name__ == "__main__":
              asyncio.run(main())
