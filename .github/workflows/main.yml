name: Daily Market Briefing (Final Fix)

on:
  schedule:
    - cron: '0 22 * * 1-5' # í•œêµ­ ì‹œê°„ ì•„ì¹¨ 7ì‹œ
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰

jobs:
  send-briefing:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Libraries
        run: pip install -U google-generativeai python-telegram-bot yfinance pytz

      - name: Run Bot Script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        shell: python
        run: |
          import os
          import asyncio
          import yfinance as yf
          import google.generativeai as genai
          from telegram import Bot
          from datetime import datetime
          import pytz

          # --- 1. í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ---
          GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY")
          TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")
          CHAT_ID = os.environ.get("CHAT_ID")

          if not GEMINI_API_KEY or not TELEGRAM_TOKEN:
              print("Error: API Key ë˜ëŠ” Token ì„¤ì • ëˆ„ë½")
              exit(1)

          genai.configure(api_key=GEMINI_API_KEY)

          # --- 2. ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜ ---
          def get_market_data():
              tickers = {
                  "S&P 500": "^GSPC",
                  "NASDAQ": "^IXIC",
                  "VIX (ê³µí¬ì§€ìˆ˜)": "^VIX",
                  "10ë…„ë¬¼ êµ­ì±„ê¸ˆë¦¬": "^TNX",
                  "ê¸°ìˆ (Tech)": "XLK",
                  "ê¸ˆìœµ": "XLF",
                  "í—¬ìŠ¤ì¼€ì–´": "XLV",
                  "ë°˜ë„ì²´": "SOXX"
              }
              
              data_summary = []
              print("ì¦ì‹œ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...")
              
              for name, ticker in tickers.items():
                  try:
                      stock = yf.Ticker(ticker)
                      hist = stock.history(period="5d")
                      
                      if len(hist) < 2:
                          continue
                          
                      current = hist['Close'].iloc[-1]
                      prev = hist['Close'].iloc[-2]
                      change = ((current - prev) / prev) * 100
                      
                      icon = "ğŸ”º" if change > 0 else "ğŸ”¹"
                      data_summary.append(f"- {name}: {current:,.2f} ({icon} {change:.2f}%)")
                  except Exception as e:
                      print(f"{name} ìˆ˜ì§‘ ì‹¤íŒ¨: {e}")
                      
              return "\n".join(data_summary)

          # --- 3. ë¸Œë¦¬í•‘ ìƒì„± í•¨ìˆ˜ (ì˜¤ë¥˜ ë°©ì§€ ë¡œì§ ì¶”ê°€) ---
          def generate_briefing(market_data):
              kst = pytz.timezone('Asia/Seoul')
              today_str = datetime.now(kst).strftime("%Yë…„ %mì›” %dì¼")
              
              prompt = f"""
              [ë‚ ì§œ]: {today_str}
              [ë°ì´í„°]:
              {market_data}
              
              ìœ„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ í…”ë ˆê·¸ë¨ ë©”ì‹ ì €ìš© 'ëª¨ë‹ ê²½ì œ ë¸Œë¦¬í•‘'ì„ ì‘ì„±í•´ì¤˜.
              
              <ì‘ì„± ì¡°ê±´>
              1. ì²« ì¤„ ì œëª©: 'ğŸ“… {today_str} ê¸€ë¡œë²Œ ì¦ì‹œ ë¸Œë¦¬í•‘'
              2. ì‹œì¥ ìš”ì•½: S&P500ê³¼ ë‚˜ìŠ¤ë‹¥ ë“±ë½ì„ ë³´ê³  ì‹œì¥ ë¶„ìœ„ê¸° í•œ ì¤„ ìš”ì•½.
              3. ì„¹í„° ë¶„ì„: ìƒìŠ¹/í•˜ë½ ì„¹í„°ì™€ ë°˜ë„ì²´ íë¦„ ì–¸ê¸‰.
              4. ì‹¬ë¦¬ ë¶„ì„: VIXì™€ êµ­ì±„ê¸ˆë¦¬ë¡œ íˆ¬ì ì‹¬ë¦¬ ì–¸ê¸‰.
              5. ë§ˆë¬´ë¦¬: íˆ¬ììë¥¼ ìœ„í•œ ì§§ì€ í•œ ì¤„ ì¡°ì–¸.
              6. ê¸¸ì´: ëª¨ë°”ì¼ ê°€ë…ì„±ì„ ìœ„í•´ 500ì ì´ë‚´, ì´ëª¨ì§€ ì‚¬ìš©.
              """
              
              # ì‚¬ìš©í•  ëª¨ë¸ í›„ë³´ ë¦¬ìŠ¤íŠ¸ (ì•ì—ì„œë¶€í„° ìˆœì„œëŒ€ë¡œ ì‹œë„)
              candidate_models = ["gemini-1.5-flash", "gemini-pro", "gemini-1.5-pro-latest"]
              
              print("Geminiì—ê²Œ ë³´ê³ ì„œ ìš”ì²­ ì¤‘...")
              
              for model_name in candidate_models:
                  try:
                      print(f"ëª¨ë¸ ì‹œë„ ì¤‘: {model_name}")
                      model = genai.GenerativeModel(model_name)
                      response = model.generate_content(prompt)
                      return response.text
                  except Exception as e:
                      print(f"âš ï¸ {model_name} ì˜¤ë¥˜ ë°œìƒ: {e}")
                      continue # ë‹¤ìŒ ëª¨ë¸ ì‹œë„
              
              # ëª¨ë“  ëª¨ë¸ì´ ì‹¤íŒ¨í–ˆì„ ê²½ìš°
              return f"âŒ AI ë¶„ì„ ì‹¤íŒ¨. ì›ë³¸ ë°ì´í„°ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.\n\n[ë°ì´í„°]\n{market_data}"

          # --- 4. ë©”ì¸ ì‹¤í–‰ ---
          async def main():
              raw_data = get_market_data()
              if not raw_data:
                  raw_data = "ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨."
              
              briefing = generate_briefing(raw_data)
              
              print("í…”ë ˆê·¸ë¨ ì „ì†¡ ì‹œì‘...")
              bot = Bot(token=TELEGRAM_TOKEN)
              await bot.send_message(chat_id=CHAT_ID, text=briefing)
              print("ì „ì†¡ ì™„ë£Œ!")

          if __name__ == "__main__":
              asyncio.run(main())
