name: Daily Market Briefing (Single File)

on:
  schedule:
    # UTC 22:00 = í•œêµ­ ì‹œê°„ ìµì¼ ì˜¤ì „ 07:00 (ì›”~ê¸ˆ ì‹¤í–‰)
    - cron: '0 22 * * 1-5'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼

jobs:
  send-briefing:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Libraries
        # í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì—¬ê¸°ì„œ ë°”ë¡œ ì„¤ì¹˜í•©ë‹ˆë‹¤.
        run: pip install google-generativeai python-telegram-bot yfinance pytz

      - name: Run Bot Script
        env:
          # GitHub Secretsì— ì €ì¥ëœ í‚¤ë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        shell: python
        run: |
          import os
          import asyncio
          import yfinance as yf
          import google.generativeai as genai
          from telegram import Bot
          from datetime import datetime
          import pytz

          # --- 1. í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ---
          GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY")
          TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")
          CHAT_ID = os.environ.get("CHAT_ID")

          if not GEMINI_API_KEY or not TELEGRAM_TOKEN:
              print("Error: API Key ë˜ëŠ” Tokenì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
              exit(1)

          # --- 2. Gemini ì„¤ì • ---
          genai.configure(api_key=GEMINI_API_KEY)
          model = genai.GenerativeModel('gemini-1.5-flash')

          # --- 3. ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜ ---
          def get_market_data():
              tickers = {
                  "S&P 500": "^GSPC",
                  "NASDAQ": "^IXIC",
                  "VIX (ê³µí¬ì§€ìˆ˜)": "^VIX",
                  "10ë…„ë¬¼ êµ­ì±„ê¸ˆë¦¬": "^TNX",
                  "ê¸°ìˆ (Tech)": "XLK",
                  "ê¸ˆìœµ": "XLF",
                  "í—¬ìŠ¤ì¼€ì–´": "XLV",
                  "ë°˜ë„ì²´": "SOXX"
              }
              
              data_summary = []
              print("ì¦ì‹œ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...")
              
              for name, ticker in tickers.items():
                  try:
                      stock = yf.Ticker(ticker)
                      # ìµœê·¼ 5ì¼ì¹˜ ê°€ì ¸ì˜´ (ì£¼ë§/íœ´ì¼ ê³ ë ¤ ë„‰ë„‰íˆ)
                      hist = stock.history(period="5d")
                      
                      if len(hist) < 2:
                          continue
                          
                      current = hist['Close'].iloc[-1]
                      prev = hist['Close'].iloc[-2]
                      change = ((current - prev) / prev) * 100
                      
                      icon = "ğŸ”º" if change > 0 else "ğŸ”¹"
                      data_summary.append(f"- {name}: {current:,.2f} ({icon} {change:.2f}%)")
                  except Exception as e:
                      print(f"{name} ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨: {e}")
                      
              return "\n".join(data_summary)

          # --- 4. ë¸Œë¦¬í•‘ ìƒì„± í•¨ìˆ˜ ---
          def generate_briefing(market_data):
              kst = pytz.timezone('Asia/Seoul')
              today_str = datetime.now(kst).strftime("%Yë…„ %mì›” %dì¼")
              
              prompt = f"""
              [ë‚ ì§œ]: {today_str}
              [ë°ì´í„°]:
              {market_data}
              
              ìœ„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ í…”ë ˆê·¸ë¨ ë©”ì‹ ì €ìš© 'ëª¨ë‹ ê²½ì œ ë¸Œë¦¬í•‘'ì„ ì‘ì„±í•´ì¤˜.
              
              <ì‘ì„± ì¡°ê±´>
              1. ë§¨ ì²« ì¤„ì— 'ğŸ“… {today_str} ê¸€ë¡œë²Œ ì¦ì‹œ ë¸Œë¦¬í•‘' ì œëª©ì„ ë‹¬ ê²ƒ.
              2. S&P500ê³¼ ë‚˜ìŠ¤ë‹¥ì„ ë¶„ì„í•˜ì—¬ 'ì˜¤ëŠ˜ì˜ ì‹œì¥ ë¶„ìœ„ê¸°'ë¥¼ í•œ ì¤„ë¡œ ìš”ì•½í•  ê²ƒ.
              3. ìƒìŠ¹/í•˜ë½ ì„¹í„°ë¥¼ ëª…í™•íˆ êµ¬ë¶„í•˜ê³  ë°˜ë„ì²´/ê¸°ìˆ ì£¼ íë¦„ì„ ì–¸ê¸‰í•  ê²ƒ.
              4. VIXì™€ êµ­ì±„ê¸ˆë¦¬ë¥¼ í†µí•´ íˆ¬ì ì‹¬ë¦¬ë¥¼ ê°„ë‹¨íˆ ë¶„ì„í•  ê²ƒ.
              5. ë§ˆì§€ë§‰ì— íˆ¬ììë¥¼ ìœ„í•œ ì§§ì€ í•œ ì¤„ ì¡°ì–¸ì„ ë„£ì„ ê²ƒ.
              6. ì „ì²´ ê¸¸ì´ëŠ” ëª¨ë°”ì¼ì—ì„œ ë³´ê¸° ì¢‹ê²Œ 500ì ì´ë‚´ë¡œ í•˜ê³  ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•  ê²ƒ.
              """
              
              print("Geminiì—ê²Œ ë³´ê³ ì„œ ìš”ì²­ ì¤‘...")
              response = model.generate_content(prompt)
              return response.text

          # --- 5. í…”ë ˆê·¸ë¨ ì „ì†¡ ë° ë©”ì¸ ì‹¤í–‰ ---
          async def main():
              # ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
              raw_data = get_market_data()
              if not raw_data:
                  raw_data = "ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨. API ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”."
              
              # AI ìš”ì•½
              briefing = generate_briefing(raw_data)
              
              # ì „ì†¡
              print("í…”ë ˆê·¸ë¨ ì „ì†¡ ì‹œì‘...")
              bot = Bot(token=TELEGRAM_TOKEN)
              
              # ë§ˆí¬ë‹¤ìš´ ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ íŠ¹ìˆ˜ë¬¸ì ì¼ë¶€ ì²˜ë¦¬ (ê°„ì´)
              # í…”ë ˆê·¸ë¨ì€ MarkdownV2ë¥¼ ì“¸ ë•Œ ì—„ê²©í•˜ë¯€ë¡œ, ê·¸ëƒ¥ ê¸°ë³¸ ëª¨ë“œë‚˜ HTMLì„ ì“°ê±°ë‚˜ 
              # ì•ˆì „í•˜ê²Œ plain textì— ê°€ê¹ê²Œ ë³´ëƒ…ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” ì•ˆì „í•˜ê²Œ Markdown ì„¤ì •ì„ ëºë‹ˆë‹¤.
              await bot.send_message(chat_id=CHAT_ID, text=briefing)
              print("ì „ì†¡ ì™„ë£Œ!")

          if __name__ == "__main__":
              asyncio.run(main())
