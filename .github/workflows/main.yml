name: Daily Market Briefing (Final Polish)

on:
  schedule:
    - cron: '0 22 * * 1-5' # í‰ì¼ ì•„ì¹¨ 7ì‹œ
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰

jobs:
  send-briefing:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Libraries
        run: pip install -U google-generativeai python-telegram-bot yfinance pytz

      - name: Run Bot Script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        shell: python
        run: |
          import os
          import asyncio
          import yfinance as yf
          import google.generativeai as genai
          from telegram import Bot
          from datetime import datetime
          import pytz

          # --- 1. í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ---
          GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY")
          TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")
          CHAT_ID = os.environ.get("CHAT_ID")

          if not GEMINI_API_KEY or not TELEGRAM_TOKEN:
              print("âŒ Error: API Key ëˆ„ë½")
              exit(1)

          genai.configure(api_key=GEMINI_API_KEY)

          # --- 2. ë°ì´í„° ìˆ˜ì§‘ ---
          def get_market_data():
              tickers = {
                  "S&P 500": "^GSPC",
                  "NASDAQ": "^IXIC",
                  "VIX (ê³µí¬ì§€ìˆ˜)": "^VIX",
                  "10ë…„ë¬¼ êµ­ì±„ê¸ˆë¦¬": "^TNX",
                  "ê¸°ìˆ (Tech)": "XLK",
                  "ê¸ˆìœµ": "XLF",
                  "í—¬ìŠ¤ì¼€ì–´": "XLV",
                  "ë°˜ë„ì²´": "SOXX"
              }
              
              data_summary = []
              print("ğŸ“Š ì¦ì‹œ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...")
              
              for name, ticker in tickers.items():
                  try:
                      stock = yf.Ticker(ticker)
                      hist = stock.history(period="5d")
                      if len(hist) < 2: continue
                      
                      current = hist['Close'].iloc[-1]
                      prev = hist['Close'].iloc[-2]
                      change = ((current - prev) / prev) * 100
                      icon = "ğŸ”º" if change > 0 else "ğŸ”¹"
                      # ë°ì´í„° í¬ë§·ì„ AIê°€ ì½ê¸° ì‰½ê²Œ ì •ë¦¬
                      data_summary.append(f"{name}: {current:,.2f} ({icon} {change:+.2f}%)")
                  except:
                      pass
              return "\n".join(data_summary)

          # --- 3. ë¸Œë¦¬í•‘ ìƒì„± (í”„ë¡¬í”„íŠ¸ ëŒ€í­ ìˆ˜ì •) ---
          def generate_briefing(market_data):
              kst = pytz.timezone('Asia/Seoul')
              today_str = datetime.now(kst).strftime("%Yë…„ %mì›” %dì¼")
              
              # ğŸ”¥ í•µì‹¬ ìˆ˜ì •: AIì—ê²Œ 'ë¹„ì„œ'ê°€ ì•„ë‹Œ 'ë¦¬í¬í„°'ì²˜ëŸ¼ í–‰ë™í•˜ë¼ê³  ì§€ì‹œ
              prompt = f"""
              [ì—­í• ]
              ë‹¹ì‹ ì€ ê°ì •ì´ ì—†ëŠ” ê¸ˆìœµ ë°ì´í„° ë¶„ì„ ë´‡ì…ë‹ˆë‹¤.
              ì¸ì‚¬ë§("ë¬¼ë¡ ì…ë‹ˆë‹¤", "ì•ˆë…•í•˜ì„¸ìš”" ë“±)ì´ë‚˜ ì„œë¡ /ê²°ë¡ ì˜ ì¡ë‹´ì„ ì ˆëŒ€ ì“°ì§€ ë§ˆì„¸ìš”.
              ì œê³µëœ [ë°ì´í„°]ì˜ ìˆ˜ì¹˜ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ì—¬ ìš”ì•½í•˜ì„¸ìš”.

              [ë°ì´í„°]
              {market_data}

              [ì¶œë ¥ ì–‘ì‹]
              ğŸ“… {today_str} ê¸€ë¡œë²Œ ì¦ì‹œ ë¸Œë¦¬í•‘

              1. ğŸ“Š ì£¼ìš” ì§€ìˆ˜
              - S&P 500ê³¼ NASDAQì˜ ë§ˆê° ì§€ìˆ˜ì™€ ë“±ë½ë¥ ì„ ë¬¸ì¥ì— í¬í•¨í•˜ì—¬ ì„¤ëª…í•˜ì„¸ìš”.
              - ì‹œì¥ ì „ë°˜ì˜ ë¶„ìœ„ê¸°(ìƒìŠ¹/í•˜ë½/í˜¼ì¡°)ë¥¼ ëª…í™•íˆ í•˜ì„¸ìš”.

              2. ğŸ“ˆ ì£¼ìš” ì§€í‘œ ë° ì‹¬ë¦¬
              - êµ­ì±„ê¸ˆë¦¬ì™€ VIX ì§€ìˆ˜ì˜ êµ¬ì²´ì  ìˆ˜ì¹˜ë¥¼ ì–¸ê¸‰í•˜ë©° ì‹œì¥ ì‹¬ë¦¬ë¥¼ ë¶„ì„í•˜ì„¸ìš”.

              3. ğŸ— ì„¹í„°ë³„ íë¦„
              - ìƒìŠ¹ ì„¹í„°ì™€ í•˜ë½ ì„¹í„°ë¥¼ ë‚˜ëˆ„ê³ , íŠ¹íˆ ë°˜ë„ì²´/ê¸°ìˆ ì£¼ì˜ ë“±ë½ë¥  ìˆ˜ì¹˜ë¥¼ ì–¸ê¸‰í•˜ì„¸ìš”.

              4. ğŸ’¡ íˆ¬ì ì½”ë©˜íŠ¸
              - ê°„ê²°í•œ í•œ ì¤„ ì¡°ì–¸.

              [ì£¼ì˜ì‚¬í•­]
              - ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì´ì„¸ìš”.
              - êµ¬ì²´ì ì¸ ìˆ«ì(ì˜ˆ: 6,700, +0.5%)ê°€ ë¹ ì§€ë©´ ì•ˆ ë©ë‹ˆë‹¤.
              """

              print("ğŸ¤– ëª¨ë¸ íƒìƒ‰ ë° ìƒì„± ì¤‘...")
              valid_model_name = None
              
              # ëª¨ë¸ ìë™ íƒìƒ‰ ë¡œì§ (ìœ ì§€)
              try:
                  for m in genai.list_models():
                      if 'generateContent' in m.supported_generation_methods:
                          if 'gemini-1.5-flash' in m.name:
                              valid_model_name = m.name
                              break
                          if 'gemini-pro' in m.name and valid_model_name is None:
                              valid_model_name = m.name
                  
                  if not valid_model_name:
                      for m in genai.list_models():
                          if 'generateContent' in m.supported_generation_methods:
                              valid_model_name = m.name
                              break
                  
                  if not valid_model_name:
                      return f"âŒ ëª¨ë¸ ì˜¤ë¥˜.\n\n{market_data}"

                  model = genai.GenerativeModel(valid_model_name)
                  response = model.generate_content(prompt)
                  return response.text.strip() # ì•ë’¤ ê³µë°± ì œê±°

              except Exception as e:
                  return f"âŒ ë¶„ì„ ì‹¤íŒ¨.\n\n{market_data}"

          # --- 4. ì‹¤í–‰ ---
          async def main():
              raw_data = get_market_data()
              if not raw_data: raw_data = "ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨"
              
              briefing = generate_briefing(raw_data)
              
              bot = Bot(token=TELEGRAM_TOKEN)
              await bot.send_message(chat_id=CHAT_ID, text=briefing)
              print("âœ… ì „ì†¡ ì™„ë£Œ")

          if __name__ == "__main__":
              asyncio.run(main())
