name: Daily Market Briefing (REST API Version)

on:
  schedule:
    - cron: '0 22 * * 1-5' # í‰ì¼ ì•„ì¹¨ 7ì‹œ (KST)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰

jobs:
  send-briefing:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Libraries
        # requests ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© (í›¨ì”¬ ì•ˆì •ì )
        run: pip install requests python-telegram-bot yfinance pytz

      - name: Run Bot Script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        shell: python
        run: |
          import os
          import requests
          import asyncio
          import yfinance as yf
          from telegram import Bot
          from datetime import datetime
          import pytz
          import json

          # --- 1. í™˜ê²½ ë³€ìˆ˜ ë° ì„¤ì • ---
          GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY")
          TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")
          CHAT_ID = os.environ.get("CHAT_ID")

          if not GEMINI_API_KEY or not TELEGRAM_TOKEN:
              print("âŒ Error: API Key ë˜ëŠ” Tokenì´ ì—†ìŠµë‹ˆë‹¤. GitHub Secretsë¥¼ í™•ì¸í•˜ì„¸ìš”.")
              exit(1)

          # --- 2. ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜ ---
          def get_market_data():
              tickers = {
                  "S&P 500": "^GSPC",
                  "NASDAQ": "^IXIC",
                  "VIX (ê³µí¬ì§€ìˆ˜)": "^VIX",
                  "10ë…„ë¬¼ êµ­ì±„ê¸ˆë¦¬": "^TNX",
                  "ê¸°ìˆ (Tech)": "XLK",
                  "ê¸ˆìœµ": "XLF",
                  "í—¬ìŠ¤ì¼€ì–´": "XLV",
                  "ë°˜ë„ì²´": "SOXX"
              }
              
              data_summary = []
              print("ğŸ“Š ì¦ì‹œ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...")
              
              for name, ticker in tickers.items():
                  try:
                      stock = yf.Ticker(ticker)
                      hist = stock.history(period="5d")
                      
                      if len(hist) < 2:
                          continue
                          
                      current = hist['Close'].iloc[-1]
                      prev = hist['Close'].iloc[-2]
                      change = ((current - prev) / prev) * 100
                      
                      icon = "ğŸ”º" if change > 0 else "ğŸ”¹"
                      data_summary.append(f"- {name}: {current:,.2f} ({icon} {change:.2f}%)")
                  except Exception as e:
                      print(f"âš ï¸ {name} ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨: {e}")
                      
              return "\n".join(data_summary)

          # --- 3. Gemini API ì§ì ‘ í˜¸ì¶œ í•¨ìˆ˜ (í•µì‹¬ ìˆ˜ì •) ---
          def generate_briefing(market_data):
              kst = pytz.timezone('Asia/Seoul')
              today_str = datetime.now(kst).strftime("%Yë…„ %mì›” %dì¼")
              
              prompt_text = f"""
              ë‹¹ì‹ ì€ ê¸ˆìœµ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì•„ë˜ ë°ì´í„°ë¥¼ ë³´ê³  í…”ë ˆê·¸ë¨ìš© 'ëª¨ë‹ ë¸Œë¦¬í•‘'ì„ ì‘ì„±í•˜ì„¸ìš”.
              
              [ë‚ ì§œ]: {today_str}
              [ì‹œì¥ ë°ì´í„°]:
              {market_data}
              
              <ì‘ì„± ê°€ì´ë“œ>
              1. ì œëª©: 'ğŸ“… {today_str} ê¸€ë¡œë²Œ ì¦ì‹œ ë¸Œë¦¬í•‘'
              2. ìš”ì•½: S&P500ê³¼ ë‚˜ìŠ¤ë‹¥ì„ ë³´ê³  ì‹œì¥ì´ ìƒìŠ¹ì„¸ì¸ì§€ í•˜ë½ì„¸ì¸ì§€ í•œ ì¤„ë¡œ ëª…í™•íˆ ìš”ì•½.
              3. ìƒì„¸: ìƒìŠ¹ ì„¹í„°ì™€ í•˜ë½ ì„¹í„°ë¥¼ êµ¬ë¶„í•˜ê³ , íŠ¹íˆ ë°˜ë„ì²´ì™€ êµ­ì±„ê¸ˆë¦¬/VIXì˜ ê´€ê³„ë¥¼ ì„¤ëª….
              4. ê²°ë¡ : íˆ¬ììë¥¼ ìœ„í•œ í•œ ì¤„ ì¡°ì–¸.
              5. í†¤ì•¤ë§¤ë„ˆ: ì „ë¬¸ì ì´ì§€ë§Œ ì‰½ê²Œ, ì´ëª¨ì§€ ì‚¬ìš©, 500ì ì´ë‚´.
              """

              # ë¼ì´ë¸ŒëŸ¬ë¦¬ ëŒ€ì‹  ì§ì ‘ URL í˜¸ì¶œ
              url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={GEMINI_API_KEY}"
              
              headers = {'Content-Type': 'application/json'}
              data = {
                  "contents": [{
                      "parts": [{"text": prompt_text}]
                  }]
              }

              print("ğŸ§  Geminiì—ê²Œ ë¶„ì„ ìš”ì²­ ì¤‘ (REST API)...")
              
              try:
                  response = requests.post(url, headers=headers, json=data)
                  
                  if response.status_code == 200:
                      result = response.json()
                      # ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
                      return result['candidates'][0]['content']['parts'][0]['text']
                  else:
                      print(f"âŒ API í˜¸ì¶œ ì‹¤íŒ¨ ì½”ë“œ: {response.status_code}")
                      print(f"âŒ ì—ëŸ¬ ë‚´ìš©: {response.text}")
                      return f"AI ë¶„ì„ ì˜¤ë¥˜ ë°œìƒ (Code {response.status_code}).\n\n[ë°ì´í„°]\n{market_data}"
                      
              except Exception as e:
                  print(f"âŒ ìš”ì²­ ì¤‘ ì˜ˆì™¸ ë°œìƒ: {e}")
                  return f"ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë°œìƒ.\n\n[ë°ì´í„°]\n{market_data}"

          # --- 4. ë©”ì¸ ì‹¤í–‰ ---
          async def main():
              raw_data = get_market_data()
              if not raw_data:
                  raw_data = "ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨. yfinance ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."
              
              briefing = generate_briefing(raw_data)
              
              print("ğŸš€ í…”ë ˆê·¸ë¨ ì „ì†¡ ì‹œì‘...")
              bot = Bot(token=TELEGRAM_TOKEN)
              # ë§ˆí¬ë‹¤ìš´ ë¬¸ì œ ë°©ì§€ë¥¼ ìœ„í•´ HTML ëª¨ë“œ ì‚¬ìš©í•˜ê±°ë‚˜ í…ìŠ¤íŠ¸ë§Œ ì „ì†¡
              await bot.send_message(chat_id=CHAT_ID, text=briefing)
              print("âœ… ì „ì†¡ ì™„ë£Œ!")

          if __name__ == "__main__":
              asyncio.run(main())
